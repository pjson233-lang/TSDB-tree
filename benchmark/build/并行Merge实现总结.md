# å¹¶è¡Œ Merge å®ç°æ€»ç»“

**å®ç°æ—¶é—´**: 2025-11-29  
**å®ç°å†…å®¹**: Step 1 - æŒ‰ leaf å¹¶è¡Œ merge

---

## ä¸€ã€å®ç°æ–¹æ¡ˆ

### 1.1 æ¶æ„è®¾è®¡

æŒ‰ç…§ä½ çš„å»ºè®®ï¼Œå®ç°äº† **Step 1: æŒ‰ leaf å¹¶è¡Œ merge**ï¼š

**ç¬¬ä¸€é˜¶æ®µï¼ˆä¸²è¡Œï¼‰**ï¼š
- æ‰«ææ‰€æœ‰ SEALED buffer ä¸­çš„ SEALED slot
- å°† slot ä¸­çš„è®°å½•æŒ‰ leaf åˆ†æ¡¶åˆ° `leaf_batches_[leaf_idx]`
- ä¸åœ¨æ­¤é˜¶æ®µæ’åºï¼Œå‡å°‘é‡å¤å·¥ä½œ

**ç¬¬äºŒé˜¶æ®µï¼ˆå¹¶è¡Œï¼‰**ï¼š
- ä¸ºæ¯ä¸ªéç©ºçš„ `leaf_batches_[leaf_idx]` å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹
- æ¯ä¸ªçº¿ç¨‹ï¼š
  1. å¯¹ batch æ’åºï¼ˆç¡®ä¿å…¨å±€æœ‰åºï¼‰
  2. è°ƒç”¨ `tree_->merge_run_into_leaf(leaf, batch)` è¿›è¡Œ merge
  3. æ›´æ–° `g_tree_max_merged_key`

### 1.2 ä»£ç æ”¹åŠ¨

**æ–‡ä»¶**: `benchmark/tsdb_core.h`

1. **MergeWorker ç±»**ï¼š
   - ä¿ç•™äº† `leaf_batches_` æˆå‘˜ï¼ˆä¹‹å‰è¢«æ³¨é‡Šæ‰ï¼Œç°åœ¨é‡æ–°ä½¿ç”¨ï¼‰

2. **MergeWorker::run_once()**ï¼š
   - å®Œå…¨é‡å†™ï¼Œå®ç°ä¸¤é˜¶æ®µå¹¶è¡Œ merge
   - ç¬¬ä¸€é˜¶æ®µï¼šä¸²è¡Œæ‰«æ + æŒ‰ leaf åˆ†æ¡¶
   - ç¬¬äºŒé˜¶æ®µï¼šå¹¶è¡Œ mergeï¼ˆä½¿ç”¨ `std::thread` + `join`ï¼‰

---

## äºŒã€æ­£ç¡®æ€§éªŒè¯

### 2.1 å•å…ƒæµ‹è¯•

æ‰€æœ‰ 13 ä¸ªå•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼š
- âœ… TestSingleThreadFlushAll
- âœ… TestMultiThreadWithFlipper
- âœ… TestTailWritingSlotVisibility
- âœ… TestSnapshotAllCorrectness
- âœ… TestScanRangeCorrectness
- âœ… TestRangeQueryInto
- âœ… TestLookupCorrectness
- âœ… TestBuildBlocksFromSlotOutOfOrder
- âœ… TestMultipleSlotsMerge
- âœ… TestCrossLeafRouting
- âœ… TestGlobalMaxMergedKey
- âœ… TestLargeScaleInsert
- âœ… TestConcurrentInsertAndMerge

**ç»“è®º**: å¹¶è¡Œ merge å®ç°**åŠŸèƒ½æ­£ç¡®**ï¼Œæ²¡æœ‰ç ´åç°æœ‰é€»è¾‘ã€‚

### 2.2 æ€§èƒ½æµ‹è¯•ï¼ˆåˆæ­¥ï¼‰

**8çº¿ç¨‹ Insert-only æµ‹è¯•**ï¼š
- Real Throughput: 31.7 Mops/sec
- Writer-only Throughput: 298.2 Mops/sec
- Merge CPU Ratio: 93.7%
- Tree records: 6,053,432 (post-flush)
- Alloc failures: 0

**è§‚å¯Ÿ**ï¼š
- Merge CPU Ratio ä»ç„¶å¾ˆé«˜ï¼ˆ93.7%ï¼‰ï¼Œè¯´æ˜å¹¶è¡Œ merge å¯èƒ½è¿˜æ²¡æœ‰å®Œå…¨å‘æŒ¥æ•ˆæœ
- å¯èƒ½åŸå› ï¼š
  1. çº¿ç¨‹åˆ›å»º/join å¼€é”€
  2. æ¯ä¸ª leaf çš„ batch å¯èƒ½å¾ˆå°ï¼Œå¹¶è¡Œåº¦ä¸å¤Ÿ
  3. éœ€è¦æ›´è¯¦ç»†çš„æ€§èƒ½åˆ†æ

---

## ä¸‰ã€ä¸ä¹‹å‰å®ç°çš„å¯¹æ¯”

### 3.1 ä¹‹å‰çš„å®ç°ï¼ˆStage 2 Step 2.1ï¼‰

- **æ–¹å¼**: ä¸²è¡Œå¤„ç†æ¯ä¸ª slotï¼Œç›´æ¥è°ƒç”¨ `build_blocks_from_slot(s)`
- **ä¼˜ç‚¹**: ç®€å•ç›´æ¥ï¼Œå‡å°‘ä¸­é—´æ‹·è´
- **ç¼ºç‚¹**: å•çº¿ç¨‹ç“¶é¢ˆï¼Œæ— æ³•åˆ©ç”¨å¤šæ ¸

### 3.2 ç°åœ¨çš„å®ç°ï¼ˆStep 1 å¹¶è¡Œï¼‰

- **æ–¹å¼**: ä¸¤é˜¶æ®µå¤„ç†ï¼Œç¬¬äºŒé˜¶æ®µå¹¶è¡Œ merge
- **ä¼˜ç‚¹**: 
  - å¯ä»¥åˆ©ç”¨å¤šæ ¸ï¼ˆæœ€å¤š kLeafCount = 16 ä¸ªçº¿ç¨‹ï¼‰
  - leaf ä¹‹é—´å®Œå…¨ç‹¬ç«‹ï¼Œæ— é”ç«äº‰
- **ç¼ºç‚¹**:
  - éœ€è¦é¢å¤–çš„å†…å­˜ï¼ˆleaf_batches_ï¼‰
  - çº¿ç¨‹åˆ›å»º/join æœ‰å¼€é”€

---

## å››ã€ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 4.1 æ€§èƒ½åˆ†æ

éœ€è¦æ›´è¯¦ç»†çš„æ€§èƒ½åˆ†æï¼Œäº†è§£ï¼š
1. **å¹¶è¡Œåº¦**: å®é™…æœ‰å¤šå°‘ä¸ª leaf æœ‰æ•°æ®ï¼Ÿå¦‚æœåªæœ‰å°‘æ•°å‡ ä¸ª leaf æœ‰æ•°æ®ï¼Œå¹¶è¡Œåº¦å°±ä½
2. **çº¿ç¨‹å¼€é”€**: åˆ›å»º/join 16 ä¸ªçº¿ç¨‹çš„å¼€é”€æœ‰å¤šå¤§ï¼Ÿ
3. **æ’åºå¼€é”€**: æ¯ä¸ª leaf batch çš„æ’åºæ—¶é—´å æ¯”ï¼Ÿ

### 4.2 å¯èƒ½çš„ä¼˜åŒ–æ–¹å‘

1. **çº¿ç¨‹æ± **: ä½¿ç”¨çº¿ç¨‹æ± ä»£æ›¿æ¯æ¬¡åˆ›å»ºæ–°çº¿ç¨‹ï¼Œå‡å°‘å¼€é”€
2. **æ‰¹é‡å¤„ç†**: å¦‚æœæŸä¸ª leaf çš„ batch å¾ˆå°ï¼Œå¯ä»¥åˆå¹¶åˆ°å…¶ä»–çº¿ç¨‹å¤„ç†
3. **Pipeline**: å®ç° Step 2 çš„ pipelineï¼Œè®©æ’åºå’Œ merge æµæ°´çº¿åŒ–

### 4.3 éªŒè¯ Lookup/Scan é—®é¢˜

æ ¹æ®ä½ çš„åˆ†æï¼ŒLookup/Scan æµ‹è¯•ä¸­ Tree ä¸º 0 çš„é—®é¢˜å¯èƒ½ä¸æ˜¯ Merge å¤±è´¥ï¼Œè€Œæ˜¯ï¼š
- æµ‹è¯•æ–¹æ³•é—®é¢˜ï¼ˆReader ç”¨æˆäº†å¸¦ RDS æ¨¡å¼ï¼‰
- æˆ–è€…æ—§ç‰ˆæœ¬ä»£ç 

éœ€è¦è¿›ä¸€æ­¥éªŒè¯ã€‚

---

## äº”ã€ç»“è®º

### âœ… å·²å®Œæˆ

1. **Step 1 å¹¶è¡Œ merge å®ç°å®Œæˆ**
   - ä»£ç ç¼–è¯‘é€šè¿‡
   - å•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
   - åŠŸèƒ½æ­£ç¡®æ€§å¾—åˆ°éªŒè¯

2. **æ€§èƒ½åˆæ­¥æµ‹è¯•**
   - 8çº¿ç¨‹æµ‹è¯•æ˜¾ç¤º Merge CPU Ratio ä»ç„¶å¾ˆé«˜
   - éœ€è¦æ›´è¯¦ç»†çš„æ€§èƒ½åˆ†ææ¥ç¡®å®šä¼˜åŒ–æ–¹å‘

### ğŸ”„ å¾…å®Œæˆ

1. **æ€§èƒ½ä¼˜åŒ–**
   - ä½¿ç”¨çº¿ç¨‹æ± ä»£æ›¿æ¯æ¬¡åˆ›å»ºæ–°çº¿ç¨‹
   - åˆ†æå¹¶è¡Œåº¦ç“¶é¢ˆ
   - è€ƒè™‘ Step 2 çš„ pipeline ä¼˜åŒ–

2. **éªŒè¯ Lookup/Scan é—®é¢˜**
   - ç¡®è®¤ Tree ä¸º 0 æ˜¯å¦çœŸçš„æ˜¯ Merge å¤±è´¥
   - å¦‚æœæ˜¯æµ‹è¯•æ–¹æ³•é—®é¢˜ï¼Œä¿®å¤æµ‹è¯•ä»£ç 

3. **å®Œæ•´æ€§èƒ½æµ‹è¯•**
   - è¿è¡Œ 1-32 çº¿ç¨‹çš„å®Œæ•´æµ‹è¯•
   - å¯¹æ¯”å¹¶è¡Œ merge å‰åçš„æ€§èƒ½å·®å¼‚

---

## å…­ã€ä»£ç ä½ç½®

- **å®ç°æ–‡ä»¶**: `benchmark/tsdb_core.h`
- **å…³é”®å‡½æ•°**: `MergeWorker::run_once()` (line ~1993)
- **æµ‹è¯•æ–‡ä»¶**: `benchmark/tsdb_tests.cpp`



